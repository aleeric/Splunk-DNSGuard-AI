<?xml version="1.0"?>
<dashboard stylesheet="dashboard.css" script="dashboard.js">
  <label>DNS Threat Detections</label>
  <description>View of detected DNS-based threats and anomalies</description>
  <row>
    <panel>
      <title>Detection Summary (Last 24 Hours)</title>
      <single>
        <search>
          <query>| inputlookup anomalous_src_lookup | search last_update > relative_time(now(), "-24h") 
          | stats dc(src) as "Hosts with Anomalies"</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="colorBy">value</option>
        <option name="colorMode">block</option>
        <option name="rangeColors">["0x53a051","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="rangeValues">[0,1,5,10]</option>
        <option name="useColors">1</option>
        <option name="unitPosition">after</option>
        <option name="unit">hosts</option>
      </single>
    </panel>
    <panel>
      <title>Detections by Type</title>
      <chart>
        <search>
          <query>| inputlookup anomalous_src_lookup | search last_update > relative_time(now(), "-24h")
          | eval "C2 Tunneling"=if(c2_tunneling=1,1,0), "Beaconing"=if(beaconing=1,1,0), "Burst Activity"=if(burst_activity=1,1,0),
                 "TXT Record Abuse"=if(txt_record_type=1,1,0), "ANY Record Abuse"=if(any_record_type=1,1,0),
                 "HINFO Record Abuse"=if(hinfo_record_type=1,1,0), "AXFR Record Abuse"=if(axfr_record_type=1,1,0),
                 "Long Query Anomaly"=if(query_length=1,1,0), "Domain Shadowing"=if(domain_shadowing=1,1,0),
                 "Behavioral Cluster"=if(behavioral_clustering=1,1,0)
          | stats sum("C2 Tunneling") as "C2 Tunneling", sum("Beaconing") as "Beaconing", 
                 sum("Burst Activity") as "Burst Activity", sum("TXT Record Abuse") as "TXT Record Abuse",
                 sum("ANY Record Abuse") as "ANY Record Abuse", sum("HINFO Record Abuse") as "HINFO Record Abuse",
                 sum("AXFR Record Abuse") as "AXFR Record Abuse", sum("Long Query Anomaly") as "Long Query Anomaly",
                 sum("Domain Shadowing") as "Domain Shadowing", sum("Behavioral Cluster") as "Behavioral Cluster"
          | transpose | rename column as "Detection Type", "row 1" as "Count"
          | where Count > 0</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.drilldown">none</option>
      </chart>
    </panel>
    <panel>
      <title>Detection Timeline</title>
      <chart>
        <search>
          <query>| inputlookup anomalous_src_lookup | search last_update > relative_time(now(), "-7d")
          | convert timeformat="%Y-%m-%d %H" ctime(last_update) as hour
          | eval "C2 Tunneling"=if(c2_tunneling=1,1,0), "Beaconing"=if(beaconing=1,1,0), "Burst Activity"=if(burst_activity=1,1,0),
                 "TXT Record Abuse"=if(txt_record_type=1,1,0), "OTHER"=if(any_record_type=1 OR hinfo_record_type=1 OR axfr_record_type=1 OR query_length=1 OR domain_shadowing=1 OR behavioral_clustering=1,1,0)
          | stats sum("C2 Tunneling") as "C2 Tunneling", sum("Beaconing") as "Beaconing", 
                 sum("Burst Activity") as "Burst Activity", sum("TXT Record Abuse") as "TXT Record Abuse",
                 sum("OTHER") as "Other Anomalies" by hour
          | sort hour</query>
          <earliest>-7d@h</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleY.text">Count</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>C2 Tunneling Detection</title>
      <table>
        <search>
          <query>| inputlookup anomalous_src_lookup | search c2_tunneling=1 last_update > relative_time(now(), "-24h")
          | table _key, last_update, src | rename _key as "ID", last_update as "Detection Time", src as "Source IP"
          | sort -"Detection Time" | head 10</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
      </table>
    </panel>
    <panel>
      <title>Beaconing Detection</title>
      <table>
        <search>
          <query>| inputlookup anomalous_src_lookup | search beaconing=1 last_update > relative_time(now(), "-24h")
          | table _key, last_update, src | rename _key as "ID", last_update as "Detection Time", src as "Source IP"
          | sort -"Detection Time" | head 10</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>DNS Burst Activity Detection</title>
      <table>
        <search>
          <query>| inputlookup anomalous_src_lookup | search burst_activity=1 last_update > relative_time(now(), "-24h")
          | table _key, last_update, src | rename _key as "ID", last_update as "Detection Time", src as "Source IP"
          | sort -"Detection Time" | head 10</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
      </table>
    </panel>
    <panel>
      <title>TXT Record Abuse Detection</title>
      <table>
        <search>
          <query>| inputlookup anomalous_src_lookup | search txt_record_type=1 last_update > relative_time(now(), "-24h")
          | table _key, last_update, src | rename _key as "ID", last_update as "Detection Time", src as "Source IP"
          | sort -"Detection Time" | head 10</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <drilldown>
          <link target="_blank">search?q=`dns_data` src=$row.Source IP$ record_type=TXT | `extract_txt_content` | table _time, src, dest, query, txt_content | sort -_time&amp;earliest=-24h@h&amp;latest=now</link>
        </drilldown>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>All Detected Anomalies (Last 24h)</title>
      <table>
        <search>
          <query>| inputlookup anomalous_src_lookup | search last_update > relative_time(now(), "-24h")
          | eval "C2 Tunneling"=if(c2_tunneling=1,"Yes","-"), "Beaconing"=if(beaconing=1,"Yes","-"), 
                 "Burst Activity"=if(burst_activity=1,"Yes","-"), "TXT Abuse"=if(txt_record_type=1,"Yes","-"),
                 "ANY Abuse"=if(any_record_type=1,"Yes","-"), "HINFO Abuse"=if(hinfo_record_type=1,"Yes","-"),
                 "AXFR Abuse"=if(axfr_record_type=1,"Yes","-"), "Long Query"=if(query_length=1,"Yes","-"), 
                 "Domain Shadowing"=if(domain_shadowing=1,"Yes","-"), "Behavioral"=if(behavioral_clustering=1,"Yes","-")
          | rename last_update as "Detection Time", src as "Source IP"
          | table "Detection Time", "Source IP", "C2 Tunneling", "Beaconing", "Burst Activity", "TXT Abuse", 
                  "ANY Abuse", "HINFO Abuse", "AXFR Abuse", "Long Query", "Domain Shadowing", "Behavioral"
          | sort -"Detection Time"</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
      </table>
    </panel>
  </row>
</dashboard> 